<?php

defined( 'ABSPATH' ) || exit;

// Prevent File Modifications
if ( ! defined( 'DISALLOW_FILE_EDIT' ) ) {
    define( 'DISALLOW_FILE_EDIT', true );
}

/**
 * Remove Actions
 */
remove_action('wp_head', 'adjacent_posts_rel_link', 10, 0);
remove_action('wp_head', 'adjacent_posts_rel_link_wp_head', 10, 0);
remove_action('wp_head', 'feed_links_extra', 3);
remove_action('wp_head', 'feed_links', 2);
remove_action('wp_head', 'index_rel_link');
remove_action('wp_head', 'parent_post_rel_link', 10, 0);
remove_action('wp_head', 'print_emoji_detection_script', 7 );
remove_action('wp_head', 'start_post_rel_link', 10, 0); 
remove_action('wp_head', 'rel_canonical');
remove_action('wp_head', 'rest_output_link_wp_head');
remove_action('wp_head', 'rsd_link');
remove_action('wp_head', 'wlwmanifest_link');
remove_action('wp_head', 'wp_generator' );
remove_action('wp_head', 'wp_oembed_add_discovery_links');
remove_action('wp_head', 'wp_oembed_add_host_js' );
remove_action('wp_head', 'wp_shortlink_wp_head', 10, 0);

// Remove the REST API endpoint.
remove_action( 'rest_api_init', 'wp_oembed_register_route' );

//Remove REST API in HTTP Headers
remove_action('template_redirect', 'rest_output_link_header', 11, 0 );

// Remove Emoji Styles
remove_action('wp_print_styles', 'print_emoji_styles');

// Disable XML RPC
add_filter( 'xmlrpc_enabled', '__return_false' );

/**
 * Remove Admin Bar
 */
function remove_admin_bar() {
    return false;
}
add_filter('show_admin_bar', 'remove_admin_bar');

function my_remove_admin_menus() {
    remove_menu_page( 'edit-comments.php' );
}
add_action( 'admin_init', 'my_remove_admin_menus' );


/**
 * Disable Gutenberg
 */
//add_filter('use_block_editor_for_post_type', '__return_false', 10);

/**
 * Disable Gutenberg Scripts
 */
add_action( 'wp_enqueue_scripts', 'remove_block_css', 100 );
function remove_block_css() {
    wp_dequeue_style( 'wp-block-library' ); // Wordpress core
    wp_dequeue_style( 'wp-block-library-theme' ); // Wordpress core
    wp_dequeue_style( 'wc-block-style' ); // WooCommerce
    wp_dequeue_style( 'storefront-gutenberg-blocks' ); // Storefront theme
}

/**
 * Remove Included Styles
 */
add_action( 'wp_enqueue_scripts', function() {
    wp_dequeue_style('global-styles');
    wp_deregister_style( 'global-styles' );
    wp_dequeue_style( 'classic-theme-styles' );
}, 100000 );    

/**
 * Stop Heartbeat API
 */
function stop_heartbeat() {
    wp_deregister_script( 'heartbeat' );
}
add_action( 'init', 'stop_heartbeat', 1 );


/**
 * Remove WordPress default author functionality for all post types
 * We use a custom Auteur CPT instead
 */
add_action( 'admin_init', 'kj_remove_default_author_functionality' );
function kj_remove_default_author_functionality() {
    // Get all registered post types
    $post_types = get_post_types( array( 'public' => true ), 'names' );
    
    // Also include built-in post types that might not be public
    $post_types[] = 'post';
    $post_types[] = 'page';
    
    // Remove duplicates
    $post_types = array_unique( $post_types );
    
    // Remove author meta box from all post types
    foreach ( $post_types as $post_type ) {
        remove_meta_box( 'authordiv', $post_type, 'normal' );
    }
    
    // Remove author column from all post type lists
    foreach ( $post_types as $post_type ) {
        add_filter( "manage_{$post_type}_posts_columns", 'kj_remove_author_column', 10, 1 );
    }
}

function kj_remove_author_column( $columns ) {
    unset( $columns['author'] );
    return $columns;
}

// Hide author filter dropdown and other author UI elements via CSS for all post types
add_action( 'admin_head', 'kj_hide_author_ui_css' );
function kj_hide_author_ui_css() {
    $screen = get_current_screen();
    if ( $screen && ( $screen->base === 'edit' || $screen->base === 'post' ) ) {
        echo '<style>
            /* Hide author filter in posts list */
            .wp-filter .author-filters,
            .wp-filter select[name="author"],
            #author-filter,
            .tablenav .alignleft.actions select[name="author"],
            .tablenav .alignleft.actions label[for="author-filter"] {
                display: none !important;
            }
            
            /* Hide author meta box in post editor (backup, already removed via remove_meta_box) */
            #authordiv {
                display: none !important;
            }
        </style>';
    }
}

// Hide author in quick edit via CSS for all post types
add_action( 'admin_footer', 'kj_hide_author_quick_edit_css' );
function kj_hide_author_quick_edit_css() {
    $screen = get_current_screen();
    if ( $screen && ( $screen->base === 'edit' || $screen->base === 'post' ) ) {
        echo '<style>
            .inline-edit-row fieldset.inline-edit-col-right .inline-edit-col label.inline-edit-author,
            .inline-edit-row fieldset.inline-edit-col-right .inline-edit-col select[name="post_author"],
            .inline-edit-row fieldset.inline-edit-col-right .inline-edit-col .inline-edit-author {
                display: none !important;
            }
        </style>';
    }
}

// Hide author from bulk edit for all post types
add_action( 'admin_footer', 'kj_hide_author_bulk_edit_css' );
function kj_hide_author_bulk_edit_css() {
    $screen = get_current_screen();
    if ( $screen && $screen->base === 'edit' ) {
        echo '<style>
            #bulk-edit fieldset.inline-edit-col-right label.inline-edit-author,
            #bulk-edit fieldset.inline-edit-col-right select[name="post_author"],
            #bulk-edit fieldset.inline-edit-col-right .inline-edit-author {
                display: none !important;
            }
        </style>';
    }
}
